# Carebase Upload & Classification Hardening – October 21, 2025

## Overview

This document details every code change implemented to improve bill-photo intake reliability, reduce false bill classifications, and introduce a review workflow for ambiguous uploads.

## 1. Classifier Heuristic Refinements

- **File:** `backend/src/services/parser.ts`  
  - Tightened bill detection by requiring a minimum token count, at least two distinct bill-oriented keywords, and structural context (due date phrasing, payment URLs, or statement terminology).  
  - Reset `RegExp` state for global patterns before each use to avoid stale matches influencing later checks.  
  - Added richer keyword lists (`past due`, `account number`) and explicit HTTPS/pay-context detection.  
  - Left appointment scoring untouched to preserve existing behavior.

- **File:** `backend/src/services/parser.test.ts`  
  - Added regression cases to guard against parking-ticket OCR slipping through as bills.  
  - Ensured concise but legitimate bills (amount + account + pay URL) still classify as `bill`.

## 2. Review Status Plumbing

- **Schema:** `backend/src/db/schema.sql`  
  - Added `review_status` column (enum-like check between `auto` and `pending_review`) to the `items` table with a default of `auto`.

- **Query Layer:**  
  - `backend/src/db/queries/items.ts` now accepts an optional review status during insert and hydrates it on reads.  
  - `backend/src/db/queries/audit.ts` resets `review_status` to `auto` when reclassifying items.

- **Shared Types:** `shared/types/index.ts`  
  - Introduced `ItemReviewStatus` union and extended the shared `Item` shape to include `reviewStatus`.

- **Schema Consumers:**  
  - Updated pg-mem fixtures in `backend/src/routes/webhook.integration.test.ts` and `backend/src/services/googleSync.testUtils.ts` so in-memory tables mirror the new column.

## 3. Upload Controller Safeguards

- **File:** `backend/src/controllers/api/upload.ts`  
  - After parsing OCR data, the controller now verifies a bill has both an amount and at least one supporting field (due date, statement date, or HTTPS payment link) before auto-creating a `bills` row.  
  - Ambiguous detections are still stored as `items`, but flagged `pending_review` with audit metadata noting the skip.  
  - The JSON response includes the persisted item (with review status) even when a bill isn’t created.

- **Tests:**  
  - `backend/src/controllers/api/upload.test.ts` unit-test ensures missing supporting fields block bill creation and set `pending_review`.  
  - `tests/src/upload.contract.test.ts` contract scenarios cover both ambiguous and well-formed uploads end-to-end (using pg-mem + supertest).

## 4. Contract-Test Infrastructure

- **File:** `tests/src/helpers/db.ts`  
  - Added a shared helper to seed pg-mem with the real schema file (path resolution via `fileURLToPath`), reducing duplication and keeping contract tests aligned with live schema.

- **File:** `tests/src/plan.contract.test.ts`  
  - Refactored to use the shared helpers instead of inlining pg-mem setup.

## 5. Mobile UX Update

- **File:** `mobile/src/screens/CameraScreen.tsx`  
  - Upload success alerts now inspect `item.reviewStatus`. If an item is `pending_review`, the banner reads “Needs review” and explains that a manual check is required before becoming a bill.

## 6. Miscellaneous

- Ensured integration fixture schemas (`backend/src/services/googleSync.testUtils.ts`, `backend/src/routes/webhook.integration.test.ts`) and unit tests compile with the new item shape.
- All npm/Nx workspace tests run clean:  
  - `npm run test:backend`  
  - `npm run test:contracts`  
  - `npm run test --workspace=mobile`

## 7. Manual Review UX (Mobile)

- Added `usePendingReviews` hook plus `mobile/src/api/review.ts` to reach the new review endpoints.
- Extended Plan screen with a “Needs review” queue, editable approval modal, and inline rejection action so caretakers can adjust fields before creating a bill.
- Added Vitest coverage for the review API client (`mobile/src/api/__tests__/reviewApi.vitest.test.ts`).

## Operational Note

Deployments must apply the `ALTER TABLE items ... review_status ...` change (or re-run the bundled `schema.sql`) before the updated backend serves uploads; otherwise inserts will fail with `column "review_status" does not exist`.
